<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Quotation Submission</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f2f4f8;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 800px;
      margin: 30px auto;
      background-color: #fff;
      padding: 20px;
      border-radius: 6px;
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.05);
      font-size: 14px;
    }

    h2 {
      text-align: center;
      font-size: 20px;
      margin-bottom: 10px;
    }

    p {
      text-align: center;
      color: #555;
      margin-bottom: 20px;
      font-size: 13px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }

    th, td {
      padding: 8px;
      border: 1px solid #ddd;
    }

    th {
      background-color: #f8f8f8;
      text-align: left;
    }

    input[type="text"],
    input[type="number"],
    input[type="date"] {
      width: 100%;
      padding: 6px;
      font-size: 13px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }

    button {
      background-color: #0078D4;
      color: #fff;
      border: none;
      padding: 10px 16px;
      font-size: 14px;
      border-radius: 4px;
      cursor: pointer;
      width: 30%;
      margin: auto;
      display: block;
    }

    button:hover {
      background-color: #005fa3;
    }

    #result {
      margin-top: 15px;
      text-align: center;
      font-weight: bold;
      font-size: 13px;
    }

    .item-block {
      border: 1px solid #ccc;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 6px;
    }
  </style>
</head>
<body>
<div class="container">
  <h2>Quotation Submission</h2>
  <p>Review item details and submit your quote:</p>

  <form id="quoteForm">
    <div id="itemsContainer"></div>

    <button type="submit">Send Quotation</button>
  </form>

  <div id="result"></div>
</div>

<script>
  const params = new URLSearchParams(window.location.search);
  const vendorNo = params.get('vendorNo');
  const indentNo = params.get('indentNo');
  const linesParam = params.get('lines');

  const itemsContainer = document.getElementById("itemsContainer");
  let linesArray = [];

  try {
    if (linesParam) {
      const decoded = decodeURIComponent(linesParam);
      linesArray = JSON.parse(decoded);
    }
  } catch (err) {
    console.error("Failed to parse lines param:", err);
    document.getElementById("result").textContent = "Error parsing item details.";
  }

  linesArray.forEach((item, index) => {
    const itemHtml = `
      <div class="item-block">
        <table>
          <tr><th colspan="2">Item ${index + 1}</th></tr>
          <tr><td>Vendor No</td><td>${vendorNo}</td></tr>
          <tr><td>Indent No</td><td>${indentNo}</td></tr>
          <tr><td>Item No</td><td>${item.itemNo}</td></tr>
          <tr><td>Description</td><td>${item.description}</td></tr>
          <tr><td>Quantity</td><td>${item.quantity}</td></tr>
          <tr><td>UOM</td><td>${item.uom}</td></tr>
          <tr><td>Expected Delivery</td><td>${item.expectedReceiptDate}</td></tr>
        </table>

        <table>
          <tr><th colspan="2">Vendor Inputs</th></tr>
          <tr><td>Unit Price</td><td><input type="number" step="0.01" name="unitPrice_${index}"></td></tr>
          <tr><td>Warranty</td><td><input type="text" name="warranty_${index}"></td></tr>
          <tr><td>Stock in Hand</td><td><input type="number" name="stockInHand_${index}"></td></tr>
          <tr><td>Vendor Item No</td><td><input type="text" name="vendorItemNo_${index}"></td></tr>
          <tr><td>Delivery Date</td><td><input type="date" name="vendorDeliveryDate_${index}"></td></tr>
        </table>
      </div>
    `;
    itemsContainer.insertAdjacentHTML("beforeend", itemHtml);
  });

  document.getElementById("quoteForm").addEventListener("submit", async function (e) {
  e.preventDefault();
  const submitBtn = this.querySelector('button[type="submit"]');
  submitBtn.disabled = true;
  submitBtn.textContent = "Submitting...";

  const filledLines = [];

  linesArray.forEach((item, index) => {
    const unitPrice = document.querySelector(`[name="unitPrice_${index}"]`).value.trim();
    const warranty = document.querySelector(`[name="warranty_${index}"]`).value.trim();
    const stockInHand = document.querySelector(`[name="stockInHand_${index}"]`).value.trim();
    const vendorItemNo = document.querySelector(`[name="vendorItemNo_${index}"]`).value.trim();
    const vendorDeliveryDate = document.querySelector(`[name="vendorDeliveryDate_${index}"]`).value;

    // Only include items where all fields are filled
    if (unitPrice && warranty && stockInHand && vendorItemNo && vendorDeliveryDate) {
      filledLines.push({
        itemNo: item.itemNo,
        description: item.description,
        quantity: Number(item.quantity),
        uom: item.uom,
        expectedReceiptDate: vendorDeliveryDate,
        unitPrice: parseFloat(unitPrice),
        warranty: warranty,
        stockInHand: parseInt(stockInHand),
        vendorItemNo: vendorItemNo
      });
    }
  });

  if (filledLines.length === 0) {
    submitBtn.disabled = false;
    submitBtn.textContent = 'Send Quotation';
    document.getElementById("result").style.color = "red";
    document.getElementById("result").textContent = "Please fill in at least one complete item to submit.";
    return;
  }

  const postData = {
    vendorNo: vendorNo,
    indentNo: indentNo,
    documentType: "Quote",
    lines: filledLines
  };

  try {
    const response = await fetch("https://quotecreation-ffh8e4cxckh7fuej.centralindia-01.azurewebsites.net/api/HttpTrigger1?", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(postData)
    });

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`Server returned ${response.status}: ${errorText}`);
    }

    const result = await response.text();
    document.getElementById("result").style.color = "green";
    document.getElementById("result").textContent = result;
    setTimeout(() => {
      window.close();
    }, 1500);
  } catch (error) {
    submitBtn.disabled = false;
    submitBtn.textContent = 'Send Quotation';
    document.getElementById("result").style.color = "red";
    document.getElementById("result").textContent = "Fetch Error: " + error.message;
  }
});


  window.addEventListener("pageshow", function (event) {
    if (event.persisted || performance.getEntriesByType("navigation")[0].type === "back_forward") {
      window.location.reload();
    }
  });
</script>
</body>
</html>


